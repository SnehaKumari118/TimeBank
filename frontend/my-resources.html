<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Resources | TimeBank</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

<!-- NAVBAR -->
<nav class="bg-indigo-600 text-white px-6 py-4 flex justify-between items-center">
  <h1 class="text-xl font-bold cursor-pointer" onclick="location.href='dashboard.html'">
    TimeBank
  </h1>

  <button onclick="location.href='upload-resource.html'"
    class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100">
    Upload New
  </button>
</nav>

<!-- PAGE -->
<main class="max-w-6xl mx-auto px-4 py-8 flex-1">

  <h2 class="text-3xl font-bold mb-8 text-center text-gray-800">
    My Uploaded Resources
  </h2>

  <div id="list"
    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 justify-items-center">
  </div>

</main>

<footer class="text-center text-gray-500 py-6 text-sm">
  © 2026 TimeBank
</footer>

<!-- EDIT MODAL -->
<div id="editModal"
  class="fixed inset-0 hidden bg-black/50 items-center justify-center z-50">

  <div class="bg-white rounded-xl w-full max-w-md p-6 shadow-xl">
    <h3 class="text-xl font-bold mb-4">✏️ Edit Resource</h3>

    <input id="modal-title"
      class="w-full border rounded-lg p-2 mb-3"
      placeholder="Title" />

    <textarea id="modal-desc"
      class="w-full border rounded-lg p-2 mb-4"
      rows="4"
      placeholder="Description"></textarea>

    <div class="flex justify-end gap-3">
      <button onclick="closeModal()"
        class="px-4 py-2 border rounded-lg hover:bg-gray-100">
        Cancel
      </button>

      <button onclick="saveEdit()"
        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
        Save
      </button>
    </div>
  </div>
</div>

<script>
const API = "http://localhost:3000";
const user = JSON.parse(localStorage.getItem("user"));
let editId = null;

if (!user) {
  alert("Please login first");
  location.href = "login.html";
}

/* LOAD RESOURCES */
fetch(`${API}/my-resources/${user.id}`)
  .then(res => res.json())
  .then(data => {
    const list = document.getElementById("list");

    if (!Array.isArray(data) || data.length === 0) {
      list.innerHTML = `
        <div class="col-span-full text-center text-gray-500 bg-white p-8 rounded-xl shadow">
          No resources uploaded yet
        </div>`;
      return;
    }

    list.innerHTML = data.map(r => `
      <div
        class="bg-white rounded-xl shadow-md hover:shadow-lg transition
               w-[300px] flex flex-col overflow-hidden">

        <!-- HEADER -->
        <div class="p-4 border-b">
          <h3 class="font-bold text-lg text-gray-800 mb-1 truncate">
            ${r.title}
          </h3>
          <p class="text-gray-600 text-sm line-clamp-2">
            ${r.description || "No description provided"}
          </p>
        </div>

        <!-- PREVIEW -->
        <div class="p-4">
          <div class="h-44 rounded-lg overflow-hidden bg-gray-100 border flex items-center justify-center">
            ${
              r.file_type === "video"
                ? `<video controls class="w-full h-full object-cover">
                     <source src="${API}/uploads/${r.file_path}">
                   </video>`
                : r.file_type === "pdf"
                ? `<iframe src="${API}/uploads/${r.file_path}"
                     class="w-full h-full"></iframe>`
                : `<span class="text-gray-400 text-sm">No preview</span>`
            }
          </div>
        </div>

        <!-- ACTIONS -->
        <div class="flex justify-between items-center px-4 py-3 mt-auto border-t bg-gray-50 text-sm">
          <button
            onclick="openEdit(${r.id}, '${escapeStr(r.title)}', '${escapeStr(r.description || "")}')"
            class="text-indigo-600 font-medium hover:underline">
            Edit
          </button>

          <button
            onclick="deleteResource(${r.id})"
            class="text-red-500 font-medium hover:underline">
            Delete
          </button>
        </div>

      </div>
    `).join("");
  });

/* ESCAPE STRINGS */
function escapeStr(str) {
  return str.replace(/'/g, "\\'");
}

/* OPEN MODAL */
function openEdit(id, title, desc) {
  editId = id;
  document.getElementById("modal-title").value = title;
  document.getElementById("modal-desc").value = desc;
  document.getElementById("editModal").classList.remove("hidden");
  document.getElementById("editModal").classList.add("flex");
}

/* CLOSE MODAL */
function closeModal() {
  document.getElementById("editModal").classList.add("hidden");
}

/* SAVE EDIT */
function saveEdit() {
  fetch(`${API}/update-resource/${editId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      title: document.getElementById("modal-title").value,
      description: document.getElementById("modal-desc").value,
      userId: user.id
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("Updated successfully");
      location.reload();
    } else {
      alert("Update failed");
    }
  });
}

/* DELETE RESOURCE */
function deleteResource(id) {
  if (!confirm("Are you sure you want to delete this resource?")) return;

  fetch(`${API}/delete-resource/${id}/${user.id}`, { method: "DELETE" })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("Deleted successfully");
        location.reload();
      } else {
        alert("Delete failed");
      }
    });
}
</script>

</body>
</html>
